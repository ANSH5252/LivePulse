<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivePulse - Admin Central</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>

    <div class="header">
        <h2 id="main-header-title">LIVEPULSE ADMIN CENTRAL</h2>
        
        <div class="menu-dropdown">
            <button class="menu-btn">‚ò∞</button>
            <div class="menu-content">
                <a href="#" onclick="goHome()">üè† Home</a>
                <a href="/logout">üö™ Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="dashboard-view">
            <button class="accordion ongoing">üü¢ Ongoing Active Polls</button>
            <div class="panel">
                {% if active_polls %}
                    {% for poll in active_polls %}
                        <div class="poll-list-item">
                            <strong style="font-size: 1.1em;">{{ poll.title }}</strong>
                            <button class="btn-view" onclick="openDetailView({{ poll.id }})">View Details ‚ûî</button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p style="padding: 15px; color: #777;">No active polls currently running.</p>
                {% endif %}
            </div>

            <button class="accordion ended">üóÑÔ∏è Ended / Archived Polls</button>
            <div class="panel">
                {% if ended_polls %}
                    {% for poll in ended_polls %}
                        <div class="poll-list-item">
                            <span style="color: #555;">{{ poll.title }}</span>
                            <button class="btn-view" style="background-color: #6c757d;" onclick="openDetailView({{ poll.id }})">View Results ‚ûî</button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p style="padding: 15px; color: #777;">No archived polls found.</p>
                {% endif %}
            </div>

            <button class="btn-create" onclick="openModal()">‚ûï Create New Poll</button>
        </div>

        <div id="detail-view">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                <h2 id="detail-title" style="margin: 0; font-size: 1.6em; color: #333;"></h2>
                <button class="btn-end-poll" id="btn-end-poll" style="display: none;">‚≠ï End Poll</button>
            </div>

            <button id="btn-manage-event" class="manage-event-btn" onclick="toggleManageEvent()" style="display: none;">
                ‚öôÔ∏è Manage Event ‚ñº
            </button>
            
            <div id="manage-event-panel" class="manage-panel">
                <div class="tool-section">
                    <h3 style="color: #5bc0de; margin-top: 0; font-size: 1.2em;">üì∑ Step 1: Scan QRs for this Event</h3>
                    <button id="btn-start-scan" style="background-color: #5bc0de; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Scan QRs</button>
                    <button id="btn-stop-scan" style="background-color: #d9534f; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; display: none;">Stop Camera</button>
                    <div id="reader" style="width: 100%; max-width: 400px; margin: 15px auto; display: none; border-radius: 8px; overflow: hidden; border: 2px solid #5bc0de;"></div>
                    <div id="scan-result" style="margin-top: 10px; font-weight: bold; font-size: 1.1em;"></div>
                </div>

                <div class="tool-section">
                    <h3 style="color: #6f42c1; margin-top: 0; font-size: 1.2em;">üì® Step 2: Dispatch Voting PINs</h3>
                    <button id="btn-dispatch" onclick="dispatchTokens()" style="background-color: #6f42c1; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Generate & Dispatch PINs</button>
                </div>

                <div class="tool-section" style="border-bottom: none; padding-bottom: 0;">
                    <h3 style="color: #d9534f; margin-top: 0; font-size: 1.2em;">üõ†Ô∏è Traffic Simulator (Admin Only)</h3>
                    <input type="number" id="sim-count" value="25" min="1" style="width: 70px; padding: 8px; display: inline-block;">
                    <select id="sim-option" style="padding: 8px; margin-right: 10px;"></select>
                    <button style="background-color: #d9534f; color: white; font-weight: bold; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;" onclick="simulateVotes()">Inject Fake Votes</button>
                    <span id="sim-msg" style="margin-left: 10px; font-weight: bold; color: #28a745;"></span>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="detailChart"></canvas>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>üìù Launch New Poll</h2>
            <form action="/admin" method="POST">
                <label>Poll Question:</label>
                <input type="text" name="title" placeholder="e.g., Best Programming Language?" required>
                <label>Voting Options:</label>
                <div id="options-container">
                    <div class="option-group"><input type="text" name="options[]" placeholder="Option 1" required></div>
                    <div class="option-group"><input type="text" name="options[]" placeholder="Option 2" required></div>
                </div>
                <button type="button" class="add-btn" onclick="addOption()">‚ûï Add Option</button>
                <button type="submit" class="submit-btn">üöÄ Launch Poll</button>
            </form>
        </div>
    </div>

    <script>
        // Modal Logic
        function openModal() { document.getElementById('createModal').style.display = 'block'; }
        function closeModal() { document.getElementById('createModal').style.display = 'none'; }
        window.onclick = function(event) { if (event.target == document.getElementById('createModal')) closeModal(); }

        let optionCount = 2;
        function addOption() {
            optionCount++;
            const container = document.getElementById('options-container');
            const newDiv = document.createElement('div');
            newDiv.className = 'option-group';
            newDiv.innerHTML = `<input type="text" name="options[]" placeholder="Option ${optionCount}" required>`;
            container.appendChild(newDiv);
        }

        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) { panel.style.maxHeight = null; } 
                else { panel.style.maxHeight = panel.scrollHeight + "px"; } 
            });
        }
        if(acc.length > 0) { acc[0].click(); acc[1].click(); }

        function toggleManageEvent() {
            const panel = document.getElementById('manage-event-panel');
            const btn = document.getElementById('btn-manage-event');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                btn.innerHTML = '‚öôÔ∏è Manage Event ‚ñ≤';
            } else {
                panel.style.display = 'none';
                btn.innerHTML = '‚öôÔ∏è Manage Event ‚ñº';
            }
        }

        function goHome() {
            stopCamera();
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('manage-event-panel').style.display = 'none';
            document.getElementById('btn-manage-event').innerHTML = '‚öôÔ∏è Manage Event ‚ñº';
            
            // Revert Header Title
            document.getElementById('main-header-title').innerText = 'LIVEPULSE ADMIN CENTRAL';
            currentlyViewedPollId = null;
        }

        const activePolls = {{ active_polls | tojson | safe if active_polls else '[]' }};
        const endedPolls = {{ ended_polls | tojson | safe if ended_polls else '[]' }};
        const allPollsMap = {};
        activePolls.forEach(p => { p.isActive = true; allPollsMap[p.id] = p; });
        endedPolls.forEach(p => { p.isActive = false; allPollsMap[p.id] = p; });

        let currentChart = null;
        let currentlyViewedPollId = null;
        let isCameraActive = false; 
        
        // Color palette mimicking your design screenshots
        const colorPalette = ['#d9534f', '#4285f4', '#5cb85c', '#f0ad4e', '#5bc0de', '#6f42c1'];

        function getSortedData(scoresObj, optionsArray) {
            const colorMap = {};
            // Lock colors to the specific option so they don't jump around when sorting
            optionsArray.forEach((opt, index) => { colorMap[opt.option_name] = colorPalette[index % colorPalette.length]; });
            
            let entries = Object.keys(scoresObj).map(key => ({ label: key, votes: Number(scoresObj[key]) }));
            
            // SORT IN ASCENDING ORDER (Lowest votes on left, highest on right)
            entries.sort((a, b) => a.votes - b.votes); 
            
            return {
                labels: entries.map(e => e.label),
                votes: entries.map(e => e.votes),
                colors: entries.map(e => colorMap[e.label] || '#6c757d')
            };
        }

        function openDetailView(pollId) {
            const poll = allPollsMap[pollId];
            currentlyViewedPollId = pollId;

            document.getElementById('dashboard-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
            
            document.getElementById('detail-title').innerText = poll.title + (poll.isActive ? " (LIVE)" : "");
            
            // Dynamic Header Transformation
            if (poll.isActive) {
                document.getElementById('main-header-title').innerText = 'LIVEPULSE LIVE POLL MANAGEMENT';
            } else {
                document.getElementById('main-header-title').innerText = 'ENDED POLLS';
            }

            const manageBtn = document.getElementById('btn-manage-event');
            const endBtn = document.getElementById('btn-end-poll');
            const simSelect = document.getElementById('sim-option');
            
            if (poll.isActive) {
                manageBtn.style.display = 'block';
                endBtn.style.display = 'inline-block';
                endBtn.onclick = () => endActivePoll(poll.id);
                
                simSelect.innerHTML = '';
                poll.options.forEach(opt => {
                    simSelect.innerHTML += `<option value="${opt.option_name}">${opt.option_name}</option>`;
                });
            } else {
                manageBtn.style.display = 'none';
                endBtn.style.display = 'none';
                document.getElementById('manage-event-panel').style.display = 'none';
            }

            if (currentChart) { currentChart.destroy(); }
            const ctx = document.getElementById('detailChart').getContext('2d');
            const sortedData = getSortedData(poll.scores, poll.options);

            const totalVotes = sortedData.votes.reduce((sum, current) => sum + current, 0);

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.labels,
                    datasets: [{ label: 'Votes', data: sortedData.votes, backgroundColor: sortedData.colors, borderWidth: 1 }]
                },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Votes = ' + totalVotes,
                            font: { size: 18, weight: 'bold' },
                            padding: { top: 10, bottom: 20 },
                            color: '#333'
                        },
                        legend: { display: false }
                    },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    animation: { duration: 500, easing: 'easeOutQuart' }
                }
            });
        }

        // --- SCANNER LOGIC ---
        const html5QrCode = new Html5Qrcode("reader");
        const btnStartScan = document.getElementById('btn-start-scan');
        const btnStopScan = document.getElementById('btn-stop-scan');
        const scanResultBox = document.getElementById('scan-result');
        const readerDiv = document.getElementById('reader');

        function onScanSuccess(decodedText) {
            html5QrCode.pause(); 
            scanResultBox.style.color = "#007bff";
            scanResultBox.innerText = "‚è≥ Verifying...";

            fetch('/api/admin/scan_ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qr_text: decodedText, poll_id: currentlyViewedPollId })
            }).then(res => res.json()).then(data => {
                if (data.error) {
                    scanResultBox.style.color = "#dc3545";
                    scanResultBox.innerText = "‚ùå " + data.error;
                } else {
                    scanResultBox.style.color = "#28a745";
                    scanResultBox.innerText = data.message;
                }
                setTimeout(() => { 
                    if(isCameraActive) { html5QrCode.resume(); scanResultBox.innerText = "Ready for next scan..."; }
                }, 2500);
            });
        }

        btnStartScan.addEventListener('click', () => {
            readerDiv.style.display = "block";
            btnStartScan.style.display = "none";
            btnStopScan.style.display = "inline-block";
            isCameraActive = true;

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).catch(err => { scanResultBox.innerText = "‚ùå Camera Error: " + err; });
        });

        function stopCamera() {
            if (!isCameraActive) return;

            isCameraActive = false;
            readerDiv.style.display = "none";
            btnStartScan.style.display = "inline-block";
            btnStopScan.style.display = "none";
            scanResultBox.innerText = "";

            try {
                html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(e => console.log(e));
            } catch (error) { console.log("Scanner already stopped."); }
        }

        btnStopScan.addEventListener('click', stopCamera);

        // --- TOKEN DISPATCH LOGIC ---
        function dispatchTokens() {
            if (!confirm("Are you sure? This will generate PINs for ALL checked-in attendees.")) return;

            const dispatchBtn = document.getElementById('btn-dispatch');
            dispatchBtn.innerText = "‚è≥ Generating...";
            dispatchBtn.disabled = true;

            fetch('/api/admin/dispatch_tokens', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ poll_id: currentlyViewedPollId })
            }).then(res => res.json()).then(data => {
                dispatchBtn.innerText = "Generate & Dispatch PINs";
                dispatchBtn.disabled = false;
                
                if (data.error) alert("‚ùå " + data.error);
                else alert("‚úÖ " + data.message);
            });
        }

        function simulateVotes() {
            const count = document.getElementById('sim-count').value;
            const optionName = document.getElementById('sim-option').value;

            fetch('/api/admin/simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ poll_id: currentlyViewedPollId, option_name: optionName, count: count })
            }).then(res => res.json()).then(data => {
                const msgBox = document.getElementById('sim-msg');
                msgBox.innerText = data.error ? "‚ùå " + data.error : "‚ö° Sent!";
                setTimeout(() => msgBox.innerText = "", 3000); 
            });
        }

        function endActivePoll(pollId) {
            if (confirm("Are you sure you want to end this poll? Users will no longer be able to vote.")) {
                fetch('/api/admin/end_poll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ poll_id: pollId })
                }).then(res => res.json()).then(data => {
                    if(!data.error) location.reload(); 
                    else alert(data.error);
                });
            }
        }

        // --- LIVE SOCKET CHART UPDATES ---
        const socket = io();
        socket.on('update_chart', function(data) {
            if (currentlyViewedPollId && allPollsMap[currentlyViewedPollId].isActive && currentChart) {
                const poll = allPollsMap[currentlyViewedPollId];
                const sorted = getSortedData(data, poll.options);
                
                currentChart.data.labels = sorted.labels;
                currentChart.data.datasets[0].data = sorted.votes;
                currentChart.data.datasets[0].backgroundColor = sorted.colors;
                
                const newTotalVotes = sorted.votes.reduce((sum, current) => sum + current, 0);
                currentChart.options.plugins.title.text = 'Total Votes = ' + newTotalVotes;
                
                currentChart.update();
            }
        });
    </script>
</body>
</html>