<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivePulse - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .poll-container { background: white; padding: 20px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; transition: 0.2s; }
        button:hover { background-color: #0056b3; transform: scale(1.05); }
        .logout-btn { background-color: #dc3545; }
        #chart-container { width: 100%; max-width: 600px; margin: 30px auto; }
        #message-box { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="header">
        <h2>LivePulse v2.0</h2>
        <div>
            <span>Welcome, <b>{{ user.username }}</b></span>
            <a href="/logout"><button class="logout-btn">Logout</button></a>
        </div>
    </div>

    <div class="poll-container" style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #007bff 0%, #6610f2 100%); color: white; text-align: left;">
        <div>
            <h3 style="margin-top: 0;">üéüÔ∏è Your Official Event Ticket</h3>
            <p>Show this QR code to the Admin at the door to check in.<br>Once scanned, you will receive your voting PIN.</p>
            <p style="font-family: monospace; font-size: 1.2em; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 4px; display: inline-block;">User ID: LIVEPULSE-{{ user.id }}</p>
        </div>
        <div style="background: white; padding: 10px; border-radius: 8px;">
            <div id="qrcode"></div>
        </div>
    </div>

    <div class="poll-container">
        {% if poll %}
            <h3>üìù Active Poll: {{ poll.title }}</h3>
            
            <div id="voting-options">
                {% for option in options %}
                    <button onclick="castVote({{ poll.id }}, {{ option.id }}, '{{ option.option_name }}')">
                        Vote for {{ option.option_name }}
                    </button>
                {% endfor %}
            </div>

            <div id="message-box"></div>
            
            <div id="chart-container">
                <canvas id="resultsChart"></canvas>
            </div>
            
        {% else %}
            <h3>No active polls at the moment.</h3>
        {% endif %}
    </div>

    <script>
        // Generate the QR Code dynamically on load
        document.addEventListener('DOMContentLoaded', function () {
            const qrString = "LIVEPULSE_USER_{{ user.id }}";
            new QRCode(document.getElementById("qrcode"), { 
                text: qrString, 
                width: 128, 
                height: 128 
            });
        });

        const socket = io();
        let liveChart;

        const colorPalette = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8'];
        const colorMap = {};
        {% for option in options %}
            colorMap['{{ option.option_name }}'] = colorPalette[{{ loop.index0 }} % colorPalette.length];
        {% endfor %}

        function getSortedData(scoresObj) {
            let entries = Object.keys(scoresObj).map(key => ({
                label: key,
                votes: Number(scoresObj[key])
            }));
            entries.sort((a, b) => a.votes - b.votes);
            return {
                labels: entries.map(e => e.label),
                votes: entries.map(e => e.votes),
                colors: entries.map(e => colorMap[e.label] || '#6c757d')
            };
        }

        const initialScores = {{ initial_scores | tojson | safe }};
        const sortedInitial = getSortedData(initialScores);

        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            
            liveChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedInitial.labels,
                    datasets: [{
                        label: 'Total Votes',
                        data: sortedInitial.votes,
                        backgroundColor: sortedInitial.colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 5 } }
                    },
                    animation: { duration: 500, easing: 'easeOutQuart' }
                }
            });
        });

        function castVote(pollId, optionId, optionName) {
            fetch('/api/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ poll_id: pollId, option_id: optionId, option_name: optionName })
            })
            .then(response => response.json())
            .then(data => {
                const msgBox = document.getElementById('message-box');
                if (data.error) {
                    msgBox.style.color = "#dc3545"; 
                    msgBox.innerText = "‚ùå " + data.error;
                } else {
                    msgBox.style.color = "#28a745"; 
                    msgBox.innerText = "‚úÖ " + data.message;
                }
            });
        }

        socket.on('update_chart', function(data) {
            if (liveChart) {
                const sorted = getSortedData(data);
                liveChart.data.labels = sorted.labels;
                liveChart.data.datasets[0].data = sorted.votes;
                liveChart.data.datasets[0].backgroundColor = sorted.colors;
                liveChart.update(); 
            }
        });
    </script>
</body>
</html>